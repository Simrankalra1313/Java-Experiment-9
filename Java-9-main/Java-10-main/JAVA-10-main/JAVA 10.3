package com.bank.entity;

import jakarta.persistence.*;

@Entity
@Table(name = "accounts")
public class Account {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String name;
    private double balance;

    public Account() {}

    public Account(String name, double balance) {
        this.name = name;
        this.balance = balance;
    }

    public int getId() { return id; }
    public String getName() { return name; }
    public double getBalance() { return balance; }

    public void setName(String name) { this.name = name; }
    public void setBalance(double balance) { this.balance = balance; }
}

package com.bank.entity;

import jakarta.persistence.*;
import java.util.Date;

@Entity
@Table(name = "transactions")
public class TransactionRecord {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private int fromAccountId;
    private int toAccountId;
    private double amount;

    @Temporal(TemporalType.TIMESTAMP)
    private Date timestamp;

    public TransactionRecord() {
        this.timestamp = new Date();
    }

    public TransactionRecord(int fromAccountId, int toAccountId, double amount) {
        this.fromAccountId = fromAccountId;
        this.toAccountId = toAccountId;
        this.amount = amount;
        this.timestamp = new Date();
    }
}

package com.bank.dao;

import com.bank.entity.Account;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import org.springframework.stereotype.Repository;

@Repository
public class AccountDAO {

    @PersistenceContext
    private EntityManager entityManager;

    public Account findById(int id) {
        return entityManager.find(Account.class, id);
    }

    public void update(Account account) {
        entityManager.merge(account);
    }

    public void save(Account account) {
        entityManager.persist(account);
    }
}

package com.bank.service;

import com.bank.dao.AccountDAO;
import com.bank.entity.Account;
import com.bank.entity.TransactionRecord;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class BankService {

    private final AccountDAO accountDAO;

    @PersistenceContext
    private EntityManager entityManager;

    public BankService(AccountDAO accountDAO) {
        this.accountDAO = accountDAO;
    }

    @Transactional
    public void transferMoney(int fromId, int toId, double amount) {
        Account fromAccount = accountDAO.findById(fromId);
        Account toAccount = accountDAO.findById(toId);

        if (fromAccount == null || toAccount == null)
            throw new RuntimeException("Account not found.");

        if (fromAccount.getBalance() < amount)
            throw new RuntimeException("Insufficient balance.");

        fromAccount.setBalance(fromAccount.getBalance() - amount);
        toAccount.setBalance(toAccount.getBalance() + amount);

        accountDAO.update(fromAccount);
        accountDAO.update(toAccount);

        TransactionRecord record = new TransactionRecord(fromId, toId, amount);
        entityManager.persist(record);

        // Uncomment to test rollback:
        // if (true) throw new RuntimeException("Simulating failure");
    }
}

package com.bank.config;

import org.springframework.context.annotation.*;
import org.springframework.orm.jpa.*;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import jakarta.persistence.EntityManagerFactory;
import javax.sql.DataSource;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

@Configuration
@ComponentScan(basePackages = "com.bank")
@EnableTransactionManagement
public class AppConfig {

    @Bean
    public DataSource dataSource() {
        DriverManagerDataSource ds = new DriverManagerDataSource();
        ds.setDriverClassName("org.h2.Driver");
        ds.setUrl("jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1");
        ds.setUsername("sa");
        ds.setPassword("");
        return ds;
    }

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(DataSource dataSource) {
        LocalContainerEntityManagerFactoryBean emf = new LocalContainerEntityManagerFactoryBean();
        emf.setDataSource(dataSource);
        emf.setPackagesToScan("com.bank.entity");
        emf.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
        return emf;
    }

    @Bean
    public JpaTransactionManager transactionManager(EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
}

package com.bank.main;

import com.bank.config.AppConfig;
import com.bank.dao.AccountDAO;
import com.bank.entity.Account;
import com.bank.service.BankService;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;

public class MainApp {
    public static void main(String[] args) {
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
        BankService bankService = context.getBean(BankService.class);
        AccountDAO accountDAO = context.getBean(AccountDAO.class);

        Account acc1 = new Account("Alice", 1000);
        Account acc2 = new Account("Bob", 500);

        accountDAO.save(acc1);
        accountDAO.save(acc2);

        System.out.println("Initial Balances:");
        System.out.println("Alice: " + acc1.getBalance() + " | Bob: " + acc2.getBalance());

        try {
            bankService.transferMoney(acc1.getId(), acc2.getId(), 200);
            System.out.println("Transfer Successful!");
        } catch (Exception e) {
            System.out.println("Transfer Failed: " + e.getMessage());
        }

        System.out.println("Final Balances:");
        System.out.println("Alice: " + accountDAO.findById(acc1.getId()).getBalance());
        System.out.println("Bob: " + accountDAO.findById(acc2.getId()).getBalance());

        context.close();
    }
}
